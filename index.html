<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <script src="static/js/jquery-3.1.0.js"></script>
    <script>
      $( document ).ready(function() {
        var acc = {
          x: [0,0,0,0,0,0,0,0,0,0],
          y: [0,0,0,0,0,0,0,0,0,0],
          z: [0,0,0,0,0,0,0,0,0,0]
        }

        var acc_gravity = {
          x: [0,0,0,0,0,0,0,0,0,0],
          y: [0,0,0,0,0,0,0,0,0,0],
          z: [0,0,0,0,0,0,0,0,0,0]
        }

        function deadband(old_val, new_val) {
          var db = 1;
          if(Math.abs(old_val-new_val) > db) {
            old_val = new_val;
          } else {
            old_val = 0;
          }
          return old_val;
        }

        function avg(vals) {
          var val_avg = 0;
          for(var i=0; i<vals.length; i++) {
            val_avg += vals[i];
          }
          return val_avg/vals.length;
        }

        function deviceMotionHandler(eventData) {
          var info, xyz = "[X, Y, Z]";
          var array_last = acc.x.length-1;

          // Grab the acceleration from the results
          var acceleration = eventData.acceleration;
          acc.x.shift();
          acc.x.push(deadband(acc.x[array_last], acceleration.x));
          acc.y.shift();
          acc.y.push(deadband(acc.y[array_last], acceleration.y));
          acc.z.shift();
          acc.z.push(deadband(acc.z[array_last], acceleration.z));

          info = xyz.replace("X", avg(acc.x));
          info = info.replace("Y", avg(acc.y));
          info = info.replace("Z", avg(acc.z));
          $("#acceleration").text(info);

          // Grab the acceleration including gravity from the results
          acceleration = eventData.accelerationIncludingGravity;
          acc_gravity.x.shift();
          acc_gravity.x.push(deadband(acc_gravity.x[array_last], acceleration.x));
          acc_gravity.y.shift();
          acc_gravity.y.push(deadband(acc_gravity.y[array_last], acceleration.y));
          acc_gravity.z.shift();
          acc_gravity.z.push(deadband(acc_gravity.z[array_last], acceleration.z));

          info = xyz.replace("X", avg(acc_gravity.x));
          info = info.replace("Y", avg(acc_gravity.y));
          info = info.replace("Z", avg(acc_gravity.z));
          $("#accelerationIncludingGravity").text(info);

          // Grab the rotation rate from the results
          var rotation = eventData.rotationRate;
          info = xyz.replace("X", rotation.alpha);
          info = info.replace("Y", rotation.beta);
          info = info.replace("Z", rotation.gamma);
          $("#rotationRate").text(info);

          // // Grab the refresh interval from the results
          info = eventData.interval;
          $("#interval").text(info);       
        }

        function updateImg(eventData) {
          console.log(eventData);
          var top_val = parseInt($('.img_crop').css('top'));
          var left_val = parseInt($('.img_crop').css('left'));
          switch(eventData.key) {
            case 'ArrowDown':
              $('.img_crop').css('top', top_val-10+'px');
              break;
            case 'ArrowUp':
              $('.img_crop').css('top', top_val+10+'px');
              break;
            case 'ArrowLeft':
              $('.img_crop').css('left', left_val+10+'px');
              break;
            case 'ArrowRight':
              $('.img_crop').css('left', left_val-10+'px');
              break;
          }
        }

        if (window.DeviceMotionEvent) {
          $('#motion_info').text('Device motion supported');
          window.addEventListener('devicemotion', deviceMotionHandler, false);
        } else {
          $('#motion_info').text('Device motion not supported');
        }

        $(document).keydown(updateImg);
      });
    </script>
    <style>
      .img_zone {
        position:relative;
        width:200px;
        height:200px;
        overflow:hidden;
      }
      .img_crop {
        position:absolute;
      }
    </style>
    <title>Motion</title>
  </head>

  <body>
    <div id="motion_info"></div>
    <div id="acceleration"></div>
    <div id="accelerationIncludingGravity"></div>
    <div id="rotationRate"></div>
    <div id="interval"></div>
    <div id="img_zone" class="img_zone">
      <img class="img_crop" src="static/img/newyork.jpg"/>
    </div>
  </body>
</html>
