<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <script src="static/js/jquery-3.1.0.js"></script>
    <script>
      $( document ).ready(function() {
        var acc = {
          x: 0,
          y: 0,
          z: 0
        }

        var acc_gravity = {
          x: 0,
          y: 0,
          z: 0
        }

        function deadband(old_val, new_val) {
          var db = 5;
          if(Math.abs(old_val-new_val) > db) {
            old_val = new_val;
          } else {
            old_val = 0;
          }
          return old_val;
        }

        function deviceMotionHandler(eventData) {
          var info, xyz = "[X, Y, Z]";

          // Grab the acceleration from the results
          var acceleration = eventData.acceleration;

          acc.x = deadband(acc.x, acceleration.x);
          acc.y = deadband(acc.y, acceleration.y);
          acc.z = deadband(acc.z, acceleration.z);

          info = xyz.replace("X", acc.x);
          info = info.replace("Y", acc.y);
          info = info.replace("Z", acc.z);
          $("#acceleration").text(info);

          // Grab the acceleration including gravity from the results
          acceleration = eventData.accelerationIncludingGravity;
          acc_gravity.x = deadband(acc_gravity.x, acceleration.x);
          acc_gravity.y = deadband(acc_gravity.y, acceleration.y);
          acc_gravity.z = deadband(acc_gravity.z, acceleration.z);

          info = xyz.replace("X", acc_gravity.x);
          info = info.replace("Y", acc_gravity.y);
          info = info.replace("Z", acc_gravity.z);
          $("#accelerationIncludingGravity").text(info);

          // Grab the rotation rate from the results
          var rotation = eventData.rotationRate;
          info = xyz.replace("X", rotation.alpha);
          info = info.replace("Y", rotation.beta);
          info = info.replace("Z", rotation.gamma);
          $("#rotationRate").text(info);

          // // Grab the refresh interval from the results
          info = eventData.interval;
          $("#interval").text(info);       
        }

        function updateImg(eventData) {
          console.log(eventData);
          var top_val = parseInt($('.img_crop').css('top'));
          var left_val = parseInt($('.img_crop').css('left'));
          switch(eventData.key) {
            case 'ArrowDown':
              $('.img_crop').css('top', top_val-10+'px');
              break;
            case 'ArrowUp':
              $('.img_crop').css('top', top_val+10+'px');
              break;
            case 'ArrowLeft':
              $('.img_crop').css('left', left_val+10+'px');
              break;
            case 'ArrowRight':
              $('.img_crop').css('left', left_val-10+'px');
              break;
          }
        }

        if (window.DeviceMotionEvent) {
          $('#motion_info').text('Device motion supported');
          window.addEventListener('devicemotion', deviceMotionHandler, false);
        } else {
          $('#motion_info').text('Device motion not supported');
        }

        $(document).keydown(updateImg);
      });
    </script>
    <style>
      .img_zone {
        position:relative;
        width:200px;
        height:200px;
        overflow:hidden;
      }
      .img_crop {
        position:absolute;
      }
    </style>
    <title>Motion</title>
  </head>

  <body>
    <div id="motion_info"></div>
    <div id="acceleration"></div>
    <div id="accelerationIncludingGravity"></div>
    <div id="rotationRate"></div>
    <div id="interval"></div>
    <div id="img_zone" class="img_zone">
      <img class="img_crop" src="static/img/newyork.jpg"/>
    </div>
  </body>
</html>
